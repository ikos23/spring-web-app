<!DOCTYPE html>
<html lang="en" ng-app="LmsApp">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
     
    <title>Learning Management System</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<link rel="stylesheet" href="app/assets/css/jumbotron-narrow.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script>
	  $( function() {
		  
		var PHASE_ID = $("phaseSelectId").val();
		var ROLE_ID = $("roleSelectId").val();
		var EMPL_ID;
		
		
		var selectedMenteeID;
		
		function loadMentors() {
			$.ajax({
	            type: "POST",
	            url: "/lms-web/loadAvailableMentors",
	            dataType: "json",
	            success: function (msg) {
	            	$("#availableMentorsSelect").empty();
	            	$.each(msg, function (i, el) {
	            		$("#availableMentorsSelect").append('<option value="' + el.id + '">' + el.firstName + ' ' + el.lastName + '</option>');
	            	});
	            },
	            error: function (errormessage) {
	            	console.log(errormessage);
	            }
	        });	
		}
		
		function addToTable(data) {
			
			var btnId = "uid" + data.employee.id;
			var addMentorOpertion = '<td>' +
		  	  '<button type="button" ' + 'id="' + btnId + '" ' +
		  	  'class="btn btn-primary btn-sm" data-toggle="modal" data-target="#myModal">' +
              'Add mentor</button></td>';
              
			
			var newRow = '<tr>' + 
				'<td>' + data.id + '</td>' +
				'<td>' + data.employee.firstName + '</td>' +
				'<td>' + data.employee.lastName + '</td>' +
				'<td>' + data.phase.name + '</td>' +
				'<td>' + data.role.name + '</td>' +
				((data.role.id == 2) ? addMentorOpertion : '<td></td>') +
			'</tr>';
			
			$("tbody", $("#addedEmplList")).append(newRow);
			
			$("#" + btnId).click(function(e) {
				selectedMenteeID = data.employee.id;
				console.log('Mentee ' + data.employee.id);
				loadMentors();
			});
		}
		
		function saveParticip() {
			$.ajax({
	            type: "POST",
	            url: "/lms-web/assignEmployee",
	            data: { roleID : $("#roleSelectId").val(),
	            	    employeeID : EMPL_ID,
	            	    phaseID : $("#phaseSelectId").val()	  
	            },
	            dataType: "json",
	            success: function (msg) {
	            	console.log(msg);
	            	addToTable(msg);
	            },
	            error: function (errormessage) {
	            	console.log(errormessage);
	            }
	        });
		}
		
		$("#addParticipantBtnId").click(function (e) {
			e.preventDefault();
			saveParticip();
			
			$("#lastNameAutoComplete").val("");
		});
		
		$("#addMentorBtnId").click(function() {
			  var payload = {
					  menteeId : selectedMenteeID,
					  mentorId : $("#availableMentorsSelect").val(),
					  plannedStart : $("#plannedStartDateID").val(),
					  plannedEnd : $("#plannedEndDateID").val()
			  };
			  
			  console.log(payload);
			  
			  $.ajax({
	            type: "POST",
	            url: "/lms-web/createGroup",
	            data: payload,
	            dataType: "json",
	            success: function (msg) {
	            	alert('Successfully  created!');
	            	console.log('Created Group : ' + msg);
	            	$('#myModal').modal('hide');
	            },
	            error: function (errormessage) {
	            	alert(errormessage);
	            }
		      });
	    });
		  
	    $( "#lastNameAutoComplete" ).autocomplete({
	      source: function (req, resp) {
		    	$.ajax({
	    		  method: "POST",
	    		  url: "/lms-web/selectEmpl",
	    		  data: { namePrefix: req.term }
	    		}).done(function(data) {
	    			resp(data);
	    		});
	      },
	      focus: function( event, ui ) {
	        $( "#lastNameAutoComplete" ).val( ui.item.firstName + ' ' +  ui.item.lastName );
	        $("#updateEmpFormID").hide();
	        return false;
	      },
	      select: function( event, ui ) {
	    	$( "#lastNameAutoComplete" ).val( ui.item.firstName + ' ' +  ui.item.lastName );
	    	
	    	EMPL_ID = ui.item.id;
	    	
	    	$("#updateEmpFormID").show();
	        console.log(ui.item);
	        return false;
	      }
	    })
	    .autocomplete( "instance" )._renderItem = function( ul, item ) {
	        return $( "<li>" )
	          .append( "<div>" + '#' + item.id + " " + item.firstName + " " + item.lastName + "</div>" )
	          .appendTo( ul );
	    };
	    
	  });
	  
  </script>
    
  </head>
  <body>
    
    <div class="container">
    
		<div class="header clearfix">
			<nav>
				<ul class="nav nav-pills pull-right">
					<li role="presentation"><a href="/lms-web/#/">Home</a></li>
					<li role="presentation"><a href="/lms-web/#/mtprogram">Mentorship Programs</a></li>
					<li role="presentation"><a href="/lms-web/edit">Edit</a></li>
					<li role="presentation"><a id="navEditPhaseId" href="/lms-web/editPhase">Program Phase Configurator</a></li>
				</ul>
			</nav>
			<h3 class="text-muted">LMS</h3>
		</div>
		
		<div class="row marketing">
    		<div>
    			<h4>Phase configurator</h4>
    			<form action="" method="POST" class="form-horizontal">
    			
    			  <div class="form-group">
			        <label for="phaseSelectId" class="col-sm-2 control-label">Phase</label>
			        <div class="col-sm-10">
			          <select class="form-control" id="phaseSelectId" >
			            <option th:if="${ #lists.isEmpty(phases) }">No phases</option>
			          	<option th:each="phase : ${phases}" th:value="${phase.id}">phase : <span th:text="${phase.name.toUpperCase()}"></span> | start : <span th:text="${{phase.startDate}}"></span> | end : <span th:text="${{phase.endDate}}"></span> || program : <span th:text="${phase.mentorshipProgram.name} "></span> </option>
			          </select>
			        </div>
			      </div>
			      <div class="form-group">
			        <label for="roleSelectId" class="col-sm-2 control-label">Role</label>
			        <div class="col-sm-10">
			          <select class="form-control" id="roleSelectId" >
			          	<option th:each="r : ${roles}" th:value="${r.id}"><span th:text="${r.name.toUpperCase()}"></span></option>
			          </select>
			        </div>
			      </div>
			      
			      <div class="form-group">
			        <label for="lastNameAutoComplete" class="col-sm-2 control-label">Employee</label>
			        <div class="col-sm-10 ui-widget">
			          <input id="lastNameAutoComplete" class="form-control" placeholder="Start typing Last Name" />
			        </div>
			      </div>
			      <div class="form-group">
			        <div class="col-sm-offset-2 col-sm-10">
			          <a href="#" id="addParticipantBtnId">Add Employee</a>
			        </div>
			      </div>
    			</form>
    		</div>
    		<div id="addedEmplList">
    		  <table class="table">
			    <thead>
			      <tr> 
			      <th>#</th>
			        <th>First Name</th>
			        <th>Last Name</th>
			        <th>Phase</th>
			        <th>Role</th>
			        <th>Operations</th>  
			      </tr> 
			    </thead>
			    <tbody></tbody>
			  </table>
    		</div>
    		
            <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Add mentor for mentee</h4>
                  </div>
                  <div class="modal-body">
                    <div>
  					  <form class="form-horizontal">		
                        <div class="form-group">
					      <label for="availableMentorsSelect" class="col-sm-2 control-label">Available mentors</label>
					      <div class="col-sm-10">
					        <select id="availableMentorsSelect" class="form-control">
					        	<option></option>
					        </select>
					      </div>
					    </div>
					    <div class="form-group">
					      <label for="plannedStartDateID" class="col-sm-2 control-label">Planned Start Date</label>
					      <div class="col-sm-10">
					        <input type="date" id="plannedStartDateID" class="form-control" />
					      </div>
					    </div>
					    <div class="form-group">
					      <label for="plannedEndDateID" class="col-sm-2 control-label">Planned End Date</label>
					      <div class="col-sm-10">
					        <input type="date" id="plannedEndDateID" class="form-control" />
					      </div>
					    </div>
                      </form>
	                </div>
                  </div>
                  <div class="modal-footer">
                    <button id="addMentorBtnId" type="button" class="btn btn-success">Add</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                  </div>
                </div>
              </div>
            </div>	
		</div>
    
    </div>
    
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js" integrity="sha256-0YPKAwZP7Mp3ALMRVB2i8GXeEndvCq3eSl/WsAl1Ryk=" crossorigin="anonymous"></script>
  </body>
</html>
